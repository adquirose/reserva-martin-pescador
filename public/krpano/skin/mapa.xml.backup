

<krpano>

    <action name="min_planta">
        <!-- Asegurar que todas las capas estén visibles antes de minimizar -->
        set(layer[mapcontainer].visible, true);
        set(layer[map].visible, true);
        set(layer[radarmask].visible, true);
        set(layer[btn_min].visible, true);
        set(layer[flecha].visible, true);
        
        <!-- Aplicar escala minimizada -->
        tween(layer[mapcontainer].scale, 0.5, 0.5, easeOutQuint);
        tween(layer[map].scale, 0.5, 0.5, easeOutQuint);
        tween(layer[radar].scale, 0.5, 0.5, easeOutQuint);
        tween(layer[btn_min].x, 0, 0.5, easeOutQuint);
        tween(layer[flecha].rotate, 180, 0.1, easeOutQuint);
        set(layer[flecha].onclick,max_planta());
        
        trace('DEBUG: min_planta ejecutado - mapa minimizado con todas las capas');
    </action>
    <action name="max_planta">
        <!-- Asegurar que todas las capas estén visibles antes de maximizar -->
        set(layer[mapcontainer].visible, true);
        set(layer[map].visible, true);
        set(layer[radarmask].visible, true);
        set(layer[btn_min].visible, true);
        set(layer[flecha].visible, true);
        
        <!-- Aplicar escala maximizada -->
        if(device.desktop,
            tween(layer[mapcontainer].scale, 1, 0.5, easeOutQuint);
            tween(layer[map].scale, 1, 0.5, easeOutQuint);
            tween(layer[radar].scale, 0.5, 0.5, easeOutQuint);
        );
        if(device.mobile,
            tween(layer[mapcontainer].scale, 0.6, 0.5, easeOutQuint);
            tween(layer[map].scale, 0.6, 0.5, easeOutQuint);
            tween(layer[radar].scale, 0.3, 0.5, easeOutQuint);
        );
        
        tween(layer[btn_min].x, 0, 0.5, easeOutQuint);
        tween(layer[flecha].rotate, 0, 0.1, easeOutQuint);
        set(layer[flecha].onclick,min_planta());
        
        trace('DEBUG: max_planta ejecutado - mapa maximizado con todas las capas');
    </action>

    <action name="toggle_radar_react">
        if(%1 == true,
            <!-- Mostrar radar -->
            set(layer[radar].visible, true);
            trace('DEBUG: toggle_radar_react(true) - radar mostrado');
        ,
            <!-- Ocultar radar -->
            set(layer[radar].visible, false);
            trace('DEBUG: toggle_radar_react(false) - radar oculto');
        );
    </action>

<!-- the image map -->

    <layer name="mapcontainer" scale.mobile="0.6" scale.normal="1" keep="true" visible="true" children="true" type="container" bgcolor="0x000000" bgalpha="0.6" align="righttop" edge="righttop" x="0" y="0" width="155" height="410">
        <layer name="btn_min" keep="true" url="map/fondo1.png" align="lefttop" edge="right" x="0" y="30" visible="true" zorder="5">
            <layer name="flecha" url="map/flecha.png" align="center" edge="center" visible="true" zorder="6" onclick="min_planta();"/>
        </layer>
        <layer name="map" scale.mobile="0.6" scale.normal="1" url="map/planta.png" align="righttop" x="4" y="4" width="145" height="400" handcursor="false">
            <!-- radar mask container -->
            <layer name="radarmask"  type="container" align="lefttop" width="100%" height="100%" maskchildren="true">

                <!-- radar plugin (usando versión JavaScript directamente) -->
                <layer name="radar" visible="false"
                       url="../plugins/radar.js"
                       align="lefttop" edge="center" zorder="1"
                       scale="1.0"
                       fillcolor="0xFFFFFF" fillalpha="0.4"
                       linecolor="0xFF0000" linewidth="0.5" linealpha="0.5"
                       headingoffset="0"
                       />

                <!-- the spots (zorder=2) -->
                <layer name="spot-e1" url="map/spot0.png" scale="0.35" onhover="showtext(Master Plan 360º Vista Etapa 1);" align="lefttop" edge="center" x="90%" y="25%" zorder="2" onclick="loadscene(scene_e1, null, MERGE, BLEND(1));" />
                <layer name="spot-e2" url="map/spot0.png" scale="0.35" onhover="showtext(Master Plan 360º Vista Etapa 2);" align="lefttop" edge="center" x="62%" y="42%" zorder="2" onclick="loadscene(scene_e2, null, MERGE, BLEND(1));" />    
                <layer name="spot-e3" url="map/spot0.png" scale="0.35" onhover="showtext(Master Plan 360º Vista Etapa 3);" align="lefttop" edge="center" x="50%" y="60%" zorder="2" onclick="loadscene(scene_e3, null, MERGE, BLEND(1));" />
                <layer name="spot-e4" url="map/spot0.png" scale="0.35" onhover="showtext(Master Plan 360º Vista Etapa 4);" align="lefttop" edge="center" x="42%" y="93%" zorder="2" onclick="loadscene(scene_e4, null, MERGE, BLEND(1));" />

                <!-- activated spot image (zorder=3 and hidden at start) -->
                <layer name="activespot" url="map/mappointactive.png" align="lefttop" scale="0.35" edge="center" ox="0" oy="0" zorder="3" visible="false" />
            </layer>
        </layer>
    </layer>

    <!-- activatespot action - %1 = the current spot, %2 = the current radar heading -->
    <action name="activatespot">
        if(%1 == false,
            <!-- hide the radar and the activespot -->
            set(layer[radar].visible, false);
            set(layer[activespot].visible, false);
            ,
            <!-- copy the spot position to the radar and activespot position -->
            set(layer[mapcontainer].visible,true);
            copy(layer[radar].x, layer[%1].x);
            copy(layer[radar].y, layer[%1].y);
            copy(layer[activespot].x, layer[%1].x);
            copy(layer[activespot].y, layer[%1].y);

            <!-- set the radar heading -->
            set(layer[radar].heading, %2);

            <!-- show the radar and the activespot -->
            set(layer[radar].visible, true);
            set(layer[activespot].visible, true);
        );
        

    </action>

    <action name="mostrar_mapa">
        <!-- %1 = visible (true/false), %2 = estado (maximized/minimized) opcional -->
        set(layer[mapcontainer].visible,%1);
        set(layer[map].visible,%1);
        if(%1 == true,
            set(layer[radarmask].visible, true);
            set(layer[btn_min].visible, true);
            set(layer[flecha].visible, true);
            
            <!-- Aplicar escala según el estado -->
            if(%2 == 'minimized',
                <!-- Estado minimizado -->
                tween(layer[mapcontainer].scale, 0.5, 0.5, easeOutQuint);
                tween(layer[map].scale, 0.5, 0.5, easeOutQuint);
                tween(layer[radar].scale, 0.5, 0.5, easeOutQuint);
                tween(layer[flecha].rotate, 180, 0.1, easeOutQuint);
                trace('DEBUG: mostrar_mapa - mapa visible y minimizado');
            ,
                <!-- Estado maximizado (por defecto) -->
                if(device.desktop,
                    tween(layer[mapcontainer].scale, 1, 0.5, easeOutQuint);
                    tween(layer[map].scale, 1, 0.5, easeOutQuint);
                    tween(layer[radar].scale, 0.5, 0.5, easeOutQuint);
                );
                if(device.mobile,
                    tween(layer[mapcontainer].scale, 0.6, 0.5, easeOutQuint);
                    tween(layer[map].scale, 0.6, 0.5, easeOutQuint);
                    tween(layer[radar].scale, 0.3, 0.5, easeOutQuint);
                );
                tween(layer[flecha].rotate, 0, 0.1, easeOutQuint);
                trace('DEBUG: mostrar_mapa - mapa visible y maximizado');
            );
        ,
            <!-- Ocultar todas las capas -->
            set(layer[radarmask].visible, false);
            set(layer[btn_min].visible, false);
            set(layer[flecha].visible, false);
            set(layer[radar].visible, false);
            trace('DEBUG: mostrar_mapa - mapa oculto completamente');
        );
    </action>

    <!-- Acciones directas para testing desde React -->
    <action name="test_hide_map">
        set(layer[mapcontainer].visible, false);
        set(layer[map].visible, false);
        set(layer[radarmask].visible, false);
        set(layer[btn_min].visible, false);
        set(layer[flecha].visible, false);
        set(layer[radar].visible, false);
        trace('DEBUG: test_hide_map ejecutado - TODAS las capas del mapa ocultadas');
    </action>

    <action name="test_show_map">
        set(layer[mapcontainer].visible, true);
        set(layer[map].visible, true);
        set(layer[radarmask].visible, true);
        set(layer[btn_min].visible, true);
        set(layer[flecha].visible, true);
        trace('DEBUG: test_show_map ejecutado - TODAS las capas del mapa mostradas');
    </action>

    <action name="test_minimize_map">
        set(layer[mapcontainer].visible, true);
        set(layer[map].visible, true);
        set(layer[radarmask].visible, true);
        set(layer[btn_min].visible, true);
        set(layer[flecha].visible, true);
        set(layer[mapcontainer].scale, 0.3);
        set(layer[map].scale, 0.3);
        set(layer[radar].scale, 0.3);
        trace('DEBUG: test_minimize_map ejecutado - escala 0.3 TODAS las capas');
    </action>

    <action name="test_maximize_map">
        set(layer[mapcontainer].visible, true);
        set(layer[map].visible, true);
        set(layer[radarmask].visible, true);
        set(layer[btn_min].visible, true);
        set(layer[flecha].visible, true);
        if(device.desktop,
            set(layer[mapcontainer].scale, 1.0);
            set(layer[map].scale, 1.0);
            set(layer[radar].scale, 0.5);
        );
        if(device.mobile,
            set(layer[mapcontainer].scale, 0.6);
            set(layer[map].scale, 0.6);
            set(layer[radar].scale, 0.3);
        );
        trace('DEBUG: test_maximize_map ejecutado - escala completa TODAS las capas');
    </action>

    <!-- Acción para controlar radar desde React -->
    <action name="toggle_radar_react">
        showlog(true);
        if(%1 == true,
            <!-- Asegurar que el mapa esté visible y maximizado para el radar -->
            set(layer[mapcontainer].visible, true);
            min_planta();
            set(layer[radar].visible, true);
            trace('DEBUG: radar activado');
            ,
            <!-- Solo ocultar el radar, mantener mapa -->
            set(layer[radar].visible, false);
            trace('DEBUG: radar desactivado');
        );
    </action>


</krpano>